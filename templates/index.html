{% extends "base.html" %}

{% block title %}Principal - Animais Perdidos{% endblock %}

{% block head_extra %}
    {{ super() }}
    <!-- Leaflet CSS para ícones customizados do Folium, se necessário -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        .folium-map { height: 60vh !important; min-height: 400px; } /* Ajuste a altura conforme necessário */
    </style>
{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h1>Plataforma PetEncontra</h1>
    <p class="lead">Ajudando a reunir pets perdidos com seus tutores.</p>
</div>

<div id="map-container">
    {% if mapa_html %}
        {{ mapa_html|safe }}
    {% else %}
        <p class="text-center">Não foi possível carregar o mapa. Verifique a conexão ou tente mais tarde.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts_extra %}
<script type="text/javascript"> // Adicionado type="text/javascript" por clareza
    // Garantir que isso seja executado e defina a função no escopo global da janela principal
    window.encerrarBuscaPet = function(petId) { // Renomeado para evitar qualquer conflito residual
        console.log("CHAMADA DE window.parent.encerrarBuscaPet - PET ID:", petId);
        if (confirm('Tem certeza que deseja encerrar a busca por este PET? Esta ação não pode ser desfeita.')) {
            const targetUrl = `/encerrar_busca/${petId}`;
            fetch(targetUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Erro do servidor: ${response.status} - ${text}`); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('Erro ao encerrar busca: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro na função encerrarBuscaPet:', error);
                alert('Ocorreu um erro de comunicação. Verifique o console do navegador.');
            });
        }
    };
  </script>
  {% endblock %}